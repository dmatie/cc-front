<app-authenticated-navbar
  [title]="isInternalUser ? i18n.t('internal.nav.title') : i18n.t('nav.home')"
  [userType]="isInternalUser ? 'internal' : 'external'">
</app-authenticated-navbar>

<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
          <h4 class="mb-0">
            <i class="bi bi-cash-coin me-2"></i>
            {{ i18n.t('disbursements.requestDetails') }}
          </h4>
          <button class="btn btn-light btn-sm" (click)="goBack()">
            <i class="bi bi-arrow-left me-2"></i>{{ i18n.t('disbursements.backToList') }}
          </button>
        </div>

        <div class="card-body">
          <div *ngIf="loading" class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">{{ i18n.t('common.loading') }}</span>
            </div>
          </div>

          @if (errorMessage) {
            <div class="alert alert-danger">
              <i class="bi bi-exclamation-triangle me-2"></i>
              {{ errorMessage }}
            </div>
          }

          @if (successMessage) {
            <div class="alert alert-success">
              <i class="bi bi-check-circle me-2"></i>
              {{ successMessage }}
            </div>
          }

          <div *ngIf="!loading && disbursement">
            <div class="d-flex justify-content-end align-items-center mb-4 gap-2">
              <button *ngIf="canSubmit()" class="btn btn-primary" (click)="showSubmitConfirm = true" [disabled]="actionLoading">
                <i class="bi bi-send me-2"></i>
                {{ i18n.t('disbursements.submit') }}
              </button>

              <button *ngIf="canApprove()" class="btn btn-success" (click)="showApproveConfirm = true" [disabled]="actionLoading">
                <i class="bi bi-check-circle me-2"></i>
                {{ i18n.t('disbursements.approve') }}
              </button>

              <button *ngIf="canReject()" class="btn btn-danger" (click)="showRejectModal = true" [disabled]="actionLoading">
                <i class="bi bi-x-circle me-2"></i>
                {{ i18n.t('disbursements.reject') }}
              </button>

              <button *ngIf="canBackToClient()" class="btn btn-warning" (click)="showBackToClientModal = true" [disabled]="actionLoading">
                <i class="bi bi-arrow-return-left me-2"></i>
                {{ i18n.t('disbursements.returnToClient') }}
              </button>

              <button *ngIf="canResubmit()" class="btn btn-primary" (click)="showResubmitModal = true" [disabled]="actionLoading">
                <i class="bi bi-arrow-repeat me-2"></i>
                {{ i18n.t('disbursements.resubmit.button') }}
              </button>

              <button *ngIf="canEdit()" class="btn btn-secondary" (click)="editDisbursement()" [disabled]="actionLoading">
                <i class="bi bi-pencil-square me-2"></i>
                {{ i18n.t('disbursements.edit.button') }}
              </button>
            </div>

            <div class="row">
              <div class="col-lg-8">
                <div class="card shadow-sm mb-4">
                  <div class="card-header bg-white">
                    <div class="d-flex justify-content-between align-items-center">
                      <h5 class="mb-0">{{ disbursement.requestNumber }}</h5>
                      <span [class]="getStatusClass(disbursement.status)">
                        {{ getStatusLabel(disbursement.status) }}
                      </span>
                    </div>
                  </div>
                  <div class="card-body">
                    <div class="row mb-3">
                      <div class="col-md-6">
                        <label class="text-muted small">{{ i18n.t('disbursements.disbursementType') }}</label>
                        <div><strong>{{ i18n.getCurrentLocale() === 'fr' ? disbursement.disbursementTypeNameFr : disbursement.disbursementTypeName }}</strong></div>
                      </div>
                      <div class="col-md-6">
                        <label class="text-muted small">{{ i18n.t('disbursements.currency') }}</label>
                        <div><strong>{{ disbursement.currency }}</strong></div>
                      </div>
                    </div>

                    <div class="row mb-3">
                      <div class="col-md-6">
                        <label class="text-muted small">{{ i18n.t('disbursements.sapCode') }}</label>
                        <div>{{ disbursement.sapCodeProject }}</div>
                      </div>
                      <div class="col-md-6">
                        <label class="text-muted small">{{ i18n.t('disbursements.loanGrantNumber') }}</label>
                        <div>{{ disbursement.loanGrantNumber }}</div>
                      </div>
                    </div>

                    <div class="row mb-3">
                      <div class="col-md-6">
                        <label class="text-muted small">{{ i18n.t('disbursements.createdBy') }}</label>
                        <div><strong>{{ disbursement.createdByUserName }}</strong></div>
                        <div class="text-muted small">{{ disbursement.createdByUserEmail }}</div>
                      </div>
                      <div class="col-md-6">
                        <label class="text-muted small">{{ i18n.t('disbursements.createdAt') }}</label>
                        <div>{{ disbursement.createdAt | date: 'full' }}</div>
                      </div>
                    </div>
                  </div>
                </div>

                <div *ngIf="disbursement.disbursementA1" class="card shadow-sm mb-4">
                  <div class="card-header bg-white">
                    <h5 class="mb-0">
                      <i class="bi bi-cash-stack me-2"></i>
                      {{ i18n.t('disbursements.typeA1.title') }}
                    </h5>
                  </div>
                  <div class="card-body">
                    <div class="mb-3">
                      <label class="text-muted small">{{ i18n.t('disbursements.typeA1.paymentPurpose') }}</label>
                      <div class="bg-light p-3 rounded">{{ disbursement.disbursementA1.paymentPurpose }}</div>
                    </div>

                    <div class="accordion" id="accordionA1">
                      <div class="accordion-item">
                        <h2 class="accordion-header">
                          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseA1Beneficiary">
                            <i class="bi bi-person-check me-2"></i>
                            {{ i18n.t('disbursements.typeA1.beneficiary') }}
                          </button>
                        </h2>
                        <div id="collapseA1Beneficiary" class="accordion-collapse collapse" data-bs-parent="#accordionA1">
                          <div class="accordion-body">
                            <div class="row">
                              <div class="col-md-6 mb-2">
                                <label class="text-muted small">{{ i18n.t('disbursements.typeA1.beneficiaryName') }}</label>
                                <div><strong>{{ disbursement.disbursementA1.beneficiaryName }}</strong></div>
                              </div>
                              <div class="col-md-6 mb-2">
                                <label class="text-muted small">{{ i18n.t('disbursements.typeA1.beneficiaryEmail') }}</label>
                                <div>{{ disbursement.disbursementA1.beneficiaryEmail }}</div>
                              </div>
                              <div class="col-md-6 mb-2">
                                <label class="text-muted small">{{ i18n.t('disbursements.typeA1.beneficiaryBpNumber') }}</label>
                                <div>{{ disbursement.disbursementA1.beneficiaryBpNumber }}</div>
                              </div>
                              <div class="col-md-6 mb-2">
                                <label class="text-muted small">{{ i18n.t('disbursements.typeA1.beneficiaryAddress') }}</label>
                                <div>{{ disbursement.disbursementA1.beneficiaryAddress }}</div>
                              </div>
                              <div class="col-md-6 mb-2">
                                <label class="text-muted small">{{ i18n.t('disbursements.typeA1.beneficiaryContactPerson') }}</label>
                                <div>{{ disbursement.disbursementA1.beneficiaryContactPerson }}</div>
                              </div>
                              <div class="col-md-6 mb-2">
                                <label class="text-muted small">{{ i18n.t('disbursements.amount') }}</label>
                                <div class="fs-5 text-success"><strong>{{ disbursement.disbursementA1.amount | number: '1.2-2' }} {{ disbursement.currency }}</strong></div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <div class="accordion-item">
                        <h2 class="accordion-header">
                          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseA1Bank">
                            <i class="bi bi-bank me-2"></i>
                            {{ i18n.t('disbursements.typeA1.correspondentBank') }}
                          </button>
                        </h2>
                        <div id="collapseA1Bank" class="accordion-collapse collapse" data-bs-parent="#accordionA1">
                          <div class="accordion-body">
                            <div class="row">
                              <div class="col-md-6 mb-2">
                                <label class="text-muted small">{{ i18n.t('disbursements.typeA1.correspondentBankName') }}</label>
                                <div>{{ disbursement.disbursementA1.correspondentBankName }}</div>
                              </div>
                              <div class="col-md-6 mb-2">
                                <label class="text-muted small">{{ i18n.t('disbursements.typeA1.correspondentBankSwiftCode') }}</label>
                                <div>{{ disbursement.disbursementA1.correspondentBankSwiftCode }}</div>
                              </div>
                              <div class="col-md-6 mb-2">
                                <label class="text-muted small">{{ i18n.t('disbursements.typeA1.correspondentAccountNumber') }}</label>
                                <div>{{ disbursement.disbursementA1.correspondantAccountNumber }}</div>
                              </div>
                              <div class="col-md-6 mb-2">
                                <label class="text-muted small">{{ i18n.t('disbursements.typeA1.correspondentBankAddress') }}</label>
                                <div>{{ disbursement.disbursementA1.correspondentBankAddress }}</div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <div class="accordion-item">
                        <h2 class="accordion-header">
                          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseA1Signatory">
                            <i class="bi bi-pen me-2"></i>
                            {{ i18n.t('disbursements.typeA1.signatory') }}
                          </button>
                        </h2>
                        <div id="collapseA1Signatory" class="accordion-collapse collapse" data-bs-parent="#accordionA1">
                          <div class="accordion-body">
                            <div class="row">
                              <div class="col-md-6 mb-2">
                                <label class="text-muted small">{{ i18n.t('disbursements.typeA1.signatoryName') }}</label>
                                <div>{{ disbursement.disbursementA1.signatoryName }}</div>
                              </div>
                              <div class="col-md-6 mb-2">
                                <label class="text-muted small">{{ i18n.t('disbursements.typeA1.signatoryEmail') }}</label>
                                <div>{{ disbursement.disbursementA1.signatoryEmail }}</div>
                              </div>
                              <div class="col-md-6 mb-2">
                                <label class="text-muted small">{{ i18n.t('disbursements.typeA1.signatoryPhone') }}</label>
                                <div>{{ disbursement.disbursementA1.signatoryPhone }}</div>
                              </div>
                              <div class="col-md-6 mb-2">
                                <label class="text-muted small">{{ i18n.t('disbursements.typeA1.signatoryContactPerson') }}</label>
                                <div>{{ disbursement.disbursementA1.signatoryContactPerson }}</div>
                              </div>
                              <div class="col-md-6 mb-2">
                                <label class="text-muted small">{{ i18n.t('disbursements.typeA1.signatoryTitle') }}</label>
                                <div>{{ disbursement.disbursementA1.signatoryTitle }}</div>
                              </div>
                              <div class="col-md-6 mb-2">
                                <label class="text-muted small">{{ i18n.t('disbursements.typeA1.signatoryAddress') }}</label>
                                <div>{{ disbursement.disbursementA1.signatoryAddress }}</div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div *ngIf="disbursement.disbursementA2" class="card shadow-sm mb-4">
                  <div class="card-header bg-white">
                    <h5 class="mb-0">
                      <i class="bi bi-receipt me-2"></i>
                      {{ i18n.t('disbursements.typeA2.title') }}
                    </h5>
                  </div>
                  <div class="card-body">
                    <div class="mb-3">
                      <label class="text-muted small">{{ i18n.t('disbursements.typeA2.reimbursementPurpose') }}</label>
                      <div class="bg-light p-3 rounded">{{ disbursement.disbursementA2.reimbursementPurpose }}</div>
                    </div>

                    <div class="row mb-3">
                      <div class="col-md-6">
                        <label class="text-muted small">{{ i18n.t('disbursements.typeA2.contractor') }}</label>
                        <div><strong>{{ disbursement.disbursementA2.contractor }}</strong></div>
                      </div>
                      <div class="col-md-6">
                        <label class="text-muted small">{{ i18n.t('disbursements.typeA2.goodDescription') }}</label>
                        <div>{{ disbursement.disbursementA2.goodDescription }}</div>
                      </div>
                    </div>

                    <div class="accordion" id="accordionA2">
                      <div class="accordion-item">
                        <h2 class="accordion-header">
                          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseA2Contract">
                            <i class="bi bi-file-earmark-text me-2"></i>
                            {{ i18n.t('disbursements.typeA2.contractSection') }}
                          </button>
                        </h2>
                        <div id="collapseA2Contract" class="accordion-collapse collapse" data-bs-parent="#accordionA2">
                          <div class="accordion-body">
                            <div class="row">
                              <div class="col-md-6 mb-2">
                                <label class="text-muted small">{{ i18n.t('disbursements.typeA2.contractBorrowerReference') }}</label>
                                <div>{{ disbursement.disbursementA2.contractBorrowerReference }}</div>
                              </div>
                              <div class="col-md-6 mb-2">
                                <label class="text-muted small">{{ i18n.t('disbursements.typeA2.contractAfDBReference') }}</label>
                                <div>{{ disbursement.disbursementA2.contractAfDBReference }}</div>
                              </div>
                              <div class="col-md-6 mb-2">
                                <label class="text-muted small">{{ i18n.t('disbursements.typeA2.contractValue') }}</label>
                                <div>{{ disbursement.disbursementA2.contractValue }}</div>
                              </div>
                              <div class="col-md-6 mb-2">
                                <label class="text-muted small">{{ i18n.t('disbursements.typeA2.contractBankShare') }}</label>
                                <div>{{ disbursement.disbursementA2.contractBankShare }}</div>
                              </div>
                              <div class="col-md-6 mb-2">
                                <label class="text-muted small">{{ i18n.t('disbursements.typeA2.contractAmountPreviouslyPaid') }}</label>
                                <div>{{ disbursement.disbursementA2.contractAmountPreviouslyPaid | number: '1.2-2' }} {{ disbursement.currency }}</div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <div class="accordion-item">
                        <h2 class="accordion-header">
                          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseA2Invoice">
                            <i class="bi bi-receipt-cutoff me-2"></i>
                            {{ i18n.t('disbursements.typeA2.invoiceSection') }}
                          </button>
                        </h2>
                        <div id="collapseA2Invoice" class="accordion-collapse collapse" data-bs-parent="#accordionA2">
                          <div class="accordion-body">
                            <div class="row">
                              <div class="col-md-6 mb-2">
                                <label class="text-muted small">{{ i18n.t('disbursements.typeA2.invoiceRef') }}</label>
                                <div>{{ disbursement.disbursementA2.invoiceRef }}</div>
                              </div>
                              <div class="col-md-6 mb-2">
                                <label class="text-muted small">{{ i18n.t('disbursements.typeA2.invoiceDate') }}</label>
                                <div>{{ disbursement.disbursementA2.invoiceDate | date: 'medium' }}</div>
                              </div>
                              <div class="col-md-6 mb-2">
                                <label class="text-muted small">{{ i18n.t('disbursements.typeA2.invoiceAmount') }}</label>
                                <div class="fs-5 text-success"><strong>{{ disbursement.disbursementA2.invoiceAmount | number: '1.2-2' }} {{ disbursement.currency }}</strong></div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <div class="accordion-item">
                        <h2 class="accordion-header">
                          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseA2Payment">
                            <i class="bi bi-credit-card me-2"></i>
                            {{ i18n.t('disbursements.typeA2.paymentSection') }}
                          </button>
                        </h2>
                        <div id="collapseA2Payment" class="accordion-collapse collapse" data-bs-parent="#accordionA2">
                          <div class="accordion-body">
                            <div class="row">
                              <div class="col-md-6 mb-2">
                                <label class="text-muted small">{{ i18n.t('disbursements.typeA2.paymentDateOfPayment') }}</label>
                                <div>{{ disbursement.disbursementA2.paymentDateOfPayment | date: 'medium' }}</div>
                              </div>
                              <div class="col-md-6 mb-2">
                                <label class="text-muted small">{{ i18n.t('disbursements.typeA2.paymentAmountWithdrawn') }}</label>
                                <div>{{ disbursement.disbursementA2.paymentAmountWithdrawn | number: '1.2-2' }} {{ disbursement.currency }}</div>
                              </div>
                              <div class="col-md-6 mb-2">
                                <label class="text-muted small">{{ i18n.t('disbursements.typeA2.paymentEvidenceOfPayment') }}</label>
                                <div>{{ disbursement.disbursementA2.paymentEvidenceOfPayment }}</div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div *ngIf="disbursement.disbursementA3" class="card shadow-sm mb-4">
                  <div class="card-header bg-white">
                    <h5 class="mb-0">
                      <i class="bi bi-building me-2"></i>
                      {{ i18n.t('disbursements.typeA3.title') }}
                    </h5>
                  </div>
                  <div class="card-body">
                    <div class="row mb-3">
                      <div class="col-md-6">
                        <label class="text-muted small">{{ i18n.t('disbursements.typeA3.periodForUtilization') }}</label>
                        <div><strong>{{ disbursement.disbursementA3.periodForUtilization }}</strong></div>
                      </div>
                      <div class="col-md-6">
                        <label class="text-muted small">{{ i18n.t('disbursements.typeA3.itemNumber') }}</label>
                        <div>{{ disbursement.disbursementA3.itemNumber }}</div>
                      </div>
                      <div class="col-md-6">
                        <label class="text-muted small">{{ i18n.t('disbursements.typeA3.goodDescription') }}</label>
                        <div>{{ disbursement.disbursementA3.goodDescription }}</div>
                      </div>
                      <div class="col-md-6">
                        <label class="text-muted small">{{ i18n.t('disbursements.typeA3.goodQuantity') }}</label>
                        <div>{{ disbursement.disbursementA3.goodQuantity }}</div>
                      </div>
                    </div>

                    <div class="accordion" id="accordionA3">
                      <div class="accordion-item">
                        <h2 class="accordion-header">
                          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseA3Budget">
                            <i class="bi bi-cash-stack me-2"></i>
                            {{ i18n.getCurrentLocale() === 'fr' ? 'Informations Budgétaires' : 'Budget Information' }}
                          </button>
                        </h2>
                        <div id="collapseA3Budget" class="accordion-collapse collapse" data-bs-parent="#accordionA3">
                          <div class="accordion-body">
                            <div class="row">
                              <div class="col-md-4 mb-2">
                                <label class="text-muted small">{{ i18n.t('disbursements.typeA3.annualBudget') }}</label>
                                <div>{{ disbursement.disbursementA3.annualBudget | number: '1.2-2' }} {{ disbursement.currency }}</div>
                              </div>
                              <div class="col-md-4 mb-2">
                                <label class="text-muted small">{{ i18n.t('disbursements.typeA3.bankShare') }}</label>
                                <div>{{ disbursement.disbursementA3.bankShare | number: '1.2-2' }} {{ disbursement.currency }}</div>
                              </div>
                              <div class="col-md-4 mb-2">
                                <label class="text-muted small">{{ i18n.t('disbursements.typeA3.advanceRequested') }}</label>
                                <div class="fs-5 text-success"><strong>{{ disbursement.disbursementA3.advanceRequested | number: '1.2-2' }} {{ disbursement.currency }}</strong></div>
                              </div>
                              <div class="col-md-6 mb-2">
                                <label class="text-muted small">{{ i18n.t('disbursements.typeA3.dateOfApproval') }}</label>
                                <div>{{ disbursement.disbursementA3.dateOfApproval | date: 'medium' }}</div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div *ngIf="disbursement.disbursementB1" class="card shadow-sm mb-4">
                  <div class="card-header bg-white">
                    <h5 class="mb-0">
                      <i class="bi bi-file-text me-2"></i>
                      {{ i18n.t('disbursements.typeB1.title') }}
                    </h5>
                  </div>
                  <div class="card-body">
                    <div class="mb-3">
                      <label class="text-muted small">{{ i18n.t('disbursements.typeB1.guaranteeDetails') }}</label>
                      <div class="bg-light p-3 rounded">{{ disbursement.disbursementB1.guaranteeDetails }}</div>
                    </div>

                    <div class="row mb-3">
                      <div class="col-md-6">
                        <label class="text-muted small">{{ i18n.t('disbursements.typeB1.confirmingBank') }}</label>
                        <div><strong>{{ disbursement.disbursementB1.confirmingBank }}</strong></div>
                      </div>
                      <div class="col-md-6">
                        <label class="text-muted small">{{ i18n.t('disbursements.typeB1.guaranteeAmount') }}</label>
                        <div class="fs-5 text-success"><strong>{{ disbursement.disbursementB1.guaranteeAmount | number: '1.2-2' }} {{ disbursement.currency }}</strong></div>
                      </div>
                    </div>

                    <div class="accordion" id="accordionB1">
                      <div class="accordion-item">
                        <h2 class="accordion-header">
                          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseB1Issuing">
                            <i class="bi bi-bank me-2"></i>
                            {{ i18n.t('disbursements.typeB1.issuingBankSection') }}
                          </button>
                        </h2>
                        <div id="collapseB1Issuing" class="accordion-collapse collapse" data-bs-parent="#accordionB1">
                          <div class="accordion-body">
                            <div class="row">
                              <div class="col-md-6 mb-2">
                                <label class="text-muted small">{{ i18n.t('disbursements.typeB1.issuingBankName') }}</label>
                                <div>{{ disbursement.disbursementB1.issuingBankName }}</div>
                              </div>
                              <div class="col-md-6 mb-2">
                                <label class="text-muted small">{{ i18n.t('disbursements.typeB1.issuingBankAddress') }}</label>
                                <div>{{ disbursement.disbursementB1.issuingBankAdress }}</div>
                              </div>
                              <div class="col-md-6 mb-2">
                                <label class="text-muted small">{{ i18n.t('disbursements.typeB1.expiryDate') }}</label>
                                <div>{{ disbursement.disbursementB1.expiryDate | date: 'medium' }}</div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <div class="accordion-item">
                        <h2 class="accordion-header">
                          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseB1Beneficiary">
                            <i class="bi bi-person-check me-2"></i>
                            {{ i18n.t('disbursements.typeB1.beneficiarySection') }}
                          </button>
                        </h2>
                        <div id="collapseB1Beneficiary" class="accordion-collapse collapse" data-bs-parent="#accordionB1">
                          <div class="accordion-body">
                            <div class="row">
                              <div class="col-md-6 mb-2">
                                <label class="text-muted small">{{ i18n.t('disbursements.typeB1.beneficiaryName') }}</label>
                                <div>{{ disbursement.disbursementB1.beneficiaryName }}</div>
                              </div>
                              <div class="col-md-6 mb-2">
                                <label class="text-muted small">{{ i18n.t('disbursements.typeB1.beneficiaryBPNumber') }}</label>
                                <div>{{ disbursement.disbursementB1.beneficiaryBPNumber }}</div>
                              </div>
                              <div class="col-md-6 mb-2">
                                <label class="text-muted small">{{ i18n.t('disbursements.typeB1.beneficiaryAFDBContract') }}</label>
                                <div>{{ disbursement.disbursementB1.beneficiaryAFDBContract }}</div>
                              </div>
                              <div class="col-md-6 mb-2">
                                <label class="text-muted small">{{ i18n.t('disbursements.typeB1.beneficiaryBankAddress') }}</label>
                                <div>{{ disbursement.disbursementB1.beneficiaryBankAddress }}</div>
                              </div>
                              <div class="col-md-6 mb-2">
                                <label class="text-muted small">{{ i18n.t('disbursements.typeB1.beneficiaryCity') }}</label>
                                <div>{{ disbursement.disbursementB1.beneficiaryCity }}</div>
                              </div>
                              <div class="col-md-6 mb-2">
                                <label class="text-muted small">{{ i18n.t('disbursements.typeB1.goodDescription') }}</label>
                                <div>{{ disbursement.disbursementB1.goodDescription }}</div>
                              </div>
                              <div class="col-md-6 mb-2">
                                <label class="text-muted small">{{ i18n.t('disbursements.typeB1.beneficiaryLcContractRef') }}</label>
                                <div>{{ disbursement.disbursementB1.beneficiaryLcContractRef }}</div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <div class="accordion-item">
                        <h2 class="accordion-header">
                          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseB1Executing">
                            <i class="bi bi-building me-2"></i>
                            {{ i18n.t('disbursements.typeB1.executingAgencySection') }}
                          </button>
                        </h2>
                        <div id="collapseB1Executing" class="accordion-collapse collapse" data-bs-parent="#accordionB1">
                          <div class="accordion-body">
                            <div class="row">
                              <div class="col-md-6 mb-2">
                                <label class="text-muted small">{{ i18n.t('disbursements.typeB1.executingAgencyName') }}</label>
                                <div>{{ disbursement.disbursementB1.executingAgencyName }}</div>
                              </div>
                              <div class="col-md-6 mb-2">
                                <label class="text-muted small">{{ i18n.t('disbursements.typeB1.executingAgencyContactPerson') }}</label>
                                <div>{{ disbursement.disbursementB1.executingAgencyContactPerson }}</div>
                              </div>
                              <div class="col-md-6 mb-2">
                                <label class="text-muted small">{{ i18n.t('disbursements.typeB1.executingAgencyEmail') }}</label>
                                <div>{{ disbursement.disbursementB1.executingAgencyEmail }}</div>
                              </div>
                              <div class="col-md-6 mb-2">
                                <label class="text-muted small">{{ i18n.t('disbursements.typeB1.executingAgencyPhone') }}</label>
                                <div>{{ disbursement.disbursementB1.executingAgencyPhone }}</div>
                              </div>
                              <div class="col-md-6 mb-2">
                                <label class="text-muted small">{{ i18n.t('disbursements.typeB1.executingAgencyAddress') }}</label>
                                <div>{{ disbursement.disbursementB1.executingAgencyAddress }}</div>
                              </div>
                              <div class="col-md-6 mb-2">
                                <label class="text-muted small">{{ i18n.t('disbursements.typeB1.executingAgencyCity') }}</label>
                                <div>{{ disbursement.disbursementB1.executingAgencyCity }}</div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div *ngIf="disbursement.documents.length > 0" class="card shadow-sm mb-4">
                  <div class="card-header bg-white">
                    <h5 class="mb-0">
                      <i class="bi bi-paperclip me-2"></i>
                      {{ i18n.getCurrentLocale() === 'fr' ? 'Documents' : 'Documents' }} ({{ disbursement.documents.length }})
                    </h5>
                  </div>
                  <div class="card-body">
                    <div class="list-group">
                      <div *ngFor="let doc of disbursement.documents" class="list-group-item">
                        <div class="d-flex justify-content-between align-items-center">
                          <div>
                            <i class="bi bi-file-earmark-pdf text-danger me-2"></i>
                            <strong>{{ doc.fileName }}</strong>
                            <small class="text-muted ms-2">({{ (doc.fileSize / 1024).toFixed(2) }} KB)</small>
                          </div>
                          <a [href]="doc.fileUrl" target="_blank" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-download me-1"></i>
                            {{ i18n.getCurrentLocale() === 'fr' ? 'Télécharger' : 'Download' }}
                          </a>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div *ngIf="disbursement.processes.length > 0" class="card shadow-sm">
                  <div class="card-header bg-white">
                    <h5 class="mb-0">
                      <i class="bi bi-chat-left-text me-2"></i>
                      {{ i18n.t('disbursements.history') }} ({{ disbursement.processes.length }})
                    </h5>
                  </div>
                  <div class="card-body">
                    <div *ngFor="let process of disbursement.processes; let last = last" [class.mb-4]="!last">
                      <div class="d-flex">
                        <div class="flex-shrink-0 me-3">
                          <div class="avatar-circle">
                            <i class="bi bi-person-fill"></i>
                          </div>
                        </div>
                        <div class="flex-grow-1">
                          <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                              <strong>{{ process.processedByUserName }}</strong>
                              <div class="text-muted small">
                                {{ process.createdAt | date: 'medium' }}
                              </div>
                            </div>
                            <span [class]="getStatusClass(process.status)">
                              {{ getStatusLabel(process.status) }}
                            </span>
                          </div>
                          <div *ngIf="process.comment" class="response-comment bg-light p-3 rounded">
                            {{ process.comment }}
                          </div>
                        </div>
                      </div>
                      <hr *ngIf="!last" class="my-4">
                    </div>
                  </div>
                </div>
              </div>

              <div class="col-lg-4">
                <div class="card shadow-sm">
                  <div class="card-header bg-white">
                    <h5 class="mb-0">{{ i18n.t('claims.timeline') }}</h5>
                  </div>
                  <div class="card-body">
                    <div class="timeline">
                      <div class="timeline-item">
                        <div class="timeline-marker bg-primary"></div>
                        <div class="timeline-content">
                          <div class="small text-muted">{{ disbursement.createdAt | date: 'short' }}</div>
                          <div><strong>{{ i18n.getCurrentLocale() === 'fr' ? 'Demande créée' : 'Request Created' }}</strong></div>
                          <div class="small">{{ i18n.getCurrentLocale() === 'fr' ? 'Par' : 'By' }} {{ disbursement.createdByUserName }}</div>
                        </div>
                      </div>

                      <div *ngFor="let process of disbursement.processes" class="timeline-item">
                        <div class="timeline-marker" [class]="getTimelineStatusClass(process.status)"></div>
                        <div class="timeline-content">
                          <div class="small text-muted">{{ process.createdAt | date: 'short' }}</div>
                          <div><strong>{{ getStatusLabel(process.status) }}</strong></div>
                          <div class="small">{{ i18n.getCurrentLocale() === 'fr' ? 'Par' : 'By' }} {{ process.processedByUserName }}</div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div *ngIf="showSubmitConfirm" class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          {{ i18n.getCurrentLocale() === 'fr' ? 'Confirmer la soumission' : 'Confirm Submission' }}
        </h5>
        <button type="button" class="btn-close" (click)="showSubmitConfirm = false"></button>
      </div>
      <div class="modal-body">
        <p>{{ i18n.getCurrentLocale() === 'fr' ? 'Êtes-vous sûr de vouloir soumettre cette demande ?' : 'Are you sure you want to submit this request?' }}</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="showSubmitConfirm = false" [disabled]="actionLoading">
          {{ i18n.getCurrentLocale() === 'fr' ? 'Annuler' : 'Cancel' }}
        </button>
        <button type="button" class="btn btn-primary" (click)="submitDisbursement()" [disabled]="actionLoading">
          {{ actionLoading ? (i18n.getCurrentLocale() === 'fr' ? 'Soumission...' : 'Submitting...') : (i18n.t('disbursements.submit')) }}
        </button>
      </div>
    </div>
  </div>
</div>

<div *ngIf="showApproveConfirm" class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          {{ i18n.getCurrentLocale() === 'fr' ? 'Confirmer l\'approbation' : 'Confirm Approval' }}
        </h5>
        <button type="button" class="btn-close" (click)="showApproveConfirm = false"></button>
      </div>
      <div class="modal-body">
        <p>{{ i18n.getCurrentLocale() === 'fr' ? 'Êtes-vous sûr de vouloir approuver cette demande ?' : 'Are you sure you want to approve this request?' }}</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="showApproveConfirm = false" [disabled]="actionLoading">
          {{ i18n.getCurrentLocale() === 'fr' ? 'Annuler' : 'Cancel' }}
        </button>
        <button type="button" class="btn btn-success" (click)="approveDisbursement()" [disabled]="actionLoading">
          {{ actionLoading ? (i18n.getCurrentLocale() === 'fr' ? 'Approbation...' : 'Approving...') : (i18n.t('disbursements.approve')) }}
        </button>
      </div>
    </div>
  </div>
</div>

<div *ngIf="showRejectModal" class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          {{ i18n.getCurrentLocale() === 'fr' ? 'Rejeter la demande' : 'Reject Request' }}
        </h5>
        <button type="button" class="btn-close" (click)="showRejectModal = false"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">
            {{ i18n.getCurrentLocale() === 'fr' ? 'Raison du rejet' : 'Reason for Rejection' }}
          </label>
          <textarea class="form-control" rows="4" [(ngModel)]="rejectComment" [ngModelOptions]="{standalone: true}"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="showRejectModal = false" [disabled]="actionLoading">
          {{ i18n.getCurrentLocale() === 'fr' ? 'Annuler' : 'Cancel' }}
        </button>
        <button type="button" class="btn btn-danger" (click)="rejectDisbursement()" [disabled]="actionLoading || !rejectComment.trim()">
          {{ actionLoading ? (i18n.getCurrentLocale() === 'fr' ? 'Rejet...' : 'Rejecting...') : (i18n.t('disbursements.reject')) }}
        </button>
      </div>
    </div>
  </div>
</div>

<div *ngIf="showBackToClientModal" class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          {{ i18n.t('disbursements.returnToClient') }}
        </h5>
        <button type="button" class="btn-close" (click)="showBackToClientModal = false"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">
            {{ i18n.getCurrentLocale() === 'fr' ? 'Commentaire' : 'Comment' }}
          </label>
          <textarea class="form-control" rows="4" [(ngModel)]="backToClientComment" [ngModelOptions]="{standalone: true}"></textarea>
        </div>
        <div class="mb-3">
          <label class="form-label">
            {{ i18n.getCurrentLocale() === 'fr' ? 'Documents additionnels (optionnel)' : 'Additional Documents (optional)' }}
          </label>
          <input type="file" class="form-control" multiple (change)="onFileSelected($event, 'backToClient')" />
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="showBackToClientModal = false" [disabled]="actionLoading">
          {{ i18n.getCurrentLocale() === 'fr' ? 'Annuler' : 'Cancel' }}
        </button>
        <button type="button" class="btn btn-warning" (click)="backToClientDisbursement()" [disabled]="actionLoading || !backToClientComment.trim()">
          {{ actionLoading ? (i18n.getCurrentLocale() === 'fr' ? 'Envoi...' : 'Sending...') : (i18n.getCurrentLocale() === 'fr' ? 'Envoyer' : 'Send') }}
        </button>
      </div>
    </div>
  </div>
</div>

<app-resubmit-disbursement-modal
  [show]="showResubmitModal"
  [disbursementId]="disbursement?.id || ''"
  (closeModal)="showResubmitModal = false"
  (resubmitSuccess)="onResubmitSuccess()"
></app-resubmit-disbursement-modal>
