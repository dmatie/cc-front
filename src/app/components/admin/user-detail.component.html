<app-authenticated-navbar [title]="i18n.t('users.detail.title')" [userType]="'internal'">
</app-authenticated-navbar>

<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-12 col-lg-10">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
          <h4 class="mb-0">
            <i class="bi bi-person-circle me-2"></i>
            {{ i18n.t('users.detail.header') }}
          </h4>
          <button class="btn btn-light btn-sm" (click)="goBack()">
            <i class="bi bi-arrow-left me-2"></i>{{ i18n.t('common.back') }}
          </button>
        </div>

        <div class="card-body">
          <!-- Success Message -->
          <div *ngIf="successMessage" class="alert alert-success alert-dismissible fade show">
            <i class="bi bi-check-circle-fill me-2"></i>
            {{ successMessage }}
            <button type="button" class="btn-close" (click)="dismissSuccess()"></button>
          </div>

          <!-- Error Message -->
          <div *ngIf="errorMessage" class="alert alert-danger alert-dismissible fade show">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            {{ errorMessage }}
            <button type="button" class="btn-close" (click)="dismissError()"></button>
          </div>

          <!-- Loading State -->
          <div *ngIf="isLoading" class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">{{ i18n.t('common.loading') }}</span>
            </div>
            <p class="text-muted mt-3">{{ i18n.t('users.detail.loading') }}</p>
          </div>

          <!-- User Details -->
          <div *ngIf="!isLoading && user">
            <!-- User Info Card -->
            <div class="card mb-4">
              <div class="card-header bg-light">
                <h5 class="mb-0">
                  <i class="bi bi-info-circle me-2"></i>
                  {{ i18n.t('users.detail.user_information') }}
                </h5>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label class="text-muted small">{{ i18n.t('users.detail.full_name') }}</label>
                    <div class="fw-bold">{{ user.fullName }}</div>
                  </div>
                  <div class="col-md-6 mb-3">
                    <label class="text-muted small">{{ i18n.t('users.detail.email') }}</label>
                    <div>
                      <a [href]="'mailto:' + user.email" class="text-decoration-none">
                        {{ user.email }}
                      </a>
                    </div>
                  </div>
                  <div class="col-md-6 mb-3">
                    <label class="text-muted small">{{ i18n.t('users.detail.role') }}</label>
                    <div>
                      <span class="badge" [ngClass]="getRoleBadgeClass(user.role)">
                        {{ getRoleLabel(user.role) }}
                      </span>
                    </div>
                  </div>
                  <div class="col-md-6 mb-3">
                    <label class="text-muted small">{{ i18n.t('users.detail.status') }}</label>
                    <div>
                      <span *ngIf="user.isActive" class="badge bg-success">
                        <i class="bi bi-check-circle me-1"></i>
                        {{ i18n.t('users.status.active') }}
                      </span>
                      <span *ngIf="!user.isActive" class="badge bg-secondary">
                        <i class="bi bi-x-circle me-1"></i>
                        {{ i18n.t('users.status.inactive') }}
                      </span>
                    </div>
                  </div>
                  <div class="col-md-6 mb-3" *ngIf="user.organizationName">
                    <label class="text-muted small">{{ i18n.t('users.detail.organization') }}</label>
                    <div>{{ user.organizationName }}</div>
                  </div>
                  <div class="col-md-6 mb-3">
                    <label class="text-muted small">{{ i18n.t('users.detail.created_at') }}</label>
                    <div>{{ user.createdAt | date:'dd/MM/yyyy HH:mm' }}</div>
                  </div>
                </div>

                <!-- Deactivate Button -->
                <div class="mt-3" *ngIf="user.isActive">
                  <button
                    class="btn btn-danger"
                    (click)="confirmDeactivate()"
                    [disabled]="isDeactivating">
                    <span *ngIf="isDeactivating" class="spinner-border spinner-border-sm me-2"></span>
                    <i class="bi bi-x-circle me-2" *ngIf="!isDeactivating"></i>
                    {{ i18n.t('users.detail.deactivate_user') }}
                  </button>
                </div>
              </div>
            </div>

            <!-- Countries Card -->
            <div class="card">
              <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                  <i class="bi bi-geo-alt me-2"></i>
                  {{ i18n.t('users.detail.assigned_countries') }}
                </h5>
                <button
                  *ngIf="user.role !== UserRole.Admin"
                  class="btn btn-primary btn-sm"
                  (click)="openAddCountriesModal()"
                  [disabled]="!user.isActive">
                  <i class="bi bi-plus-circle me-2"></i>
                  {{ i18n.t('users.detail.add_countries') }}
                </button>
              </div>
              <div class="card-body">
                <div *ngIf="!user.countries || user.countries.length === 0" class="text-muted text-center py-4">
                  <i class="bi bi-geo-alt" style="font-size: 3rem;"></i>
                  <p class="mt-2">{{ i18n.t('users.detail.no_countries') }}</p>
                </div>

                <div *ngIf="user.countries && user.countries.length > 0">
                  <div class="table-responsive">
                    <table class="table table-hover mb-0">
                      <thead class="table-light">
                        <tr>
                          <th>{{ i18n.t('users.detail.country_name') }}</th>
                          <th>{{ i18n.t('users.detail.country_code') }}</th>
                          <th>{{ i18n.t('users.detail.country_status') }}</th>
                          <th class="text-end">{{ i18n.t('common.actions') }}</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr *ngFor="let country of user.countries">
                          <td>{{ country.countryName }}</td>
                          <td><span class="badge bg-secondary">{{ country.counrtyCode }}</span></td>
                          <td>
                            <span *ngIf="country.isActive" class="badge bg-success">
                              {{ i18n.t('common.active') }}
                            </span>
                            <span *ngIf="!country.isActive" class="badge bg-secondary">
                              {{ i18n.t('common.inactive') }}
                            </span>
                          </td>
                          <td class="text-end">
                            <button
                              class="btn btn-sm btn-outline-danger"
                              (click)="confirmRemoveCountry(country.countryId)"
                              [disabled]="!user.isActive || isRemovingCountry">
                              <i class="bi bi-trash me-1"></i>
                              {{ i18n.t('common.remove') }}
                            </button>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add Countries Modal -->
<div *ngIf="showAddCountriesModal" class="modal fade show d-block" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">{{ i18n.t('users.detail.add_countries_modal_title') }}</h5>
        <button type="button" class="btn-close" (click)="closeAddCountriesModal()"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">{{ i18n.t('users.detail.select_countries') }}</label>
          <div class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
            <div class="row g-2">
              <div class="col-12" *ngFor="let country of availableCountries">
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    [id]="'country-add-' + country.id"
                    [checked]="isCountrySelectedForAdd(country.id)"
                    (change)="onCountrySelectionChange(country.id, $event)"
                  >
                  <label class="form-check-label" [for]="'country-add-' + country.id">
                    {{ getCountryLabel(country) }} - [{{ country.code }}]
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeAddCountriesModal()">
          {{ i18n.t('common.cancel') }}
        </button>
        <button
          type="button"
          class="btn btn-primary"
          (click)="addSelectedCountries()"
          [disabled]="selectedCountryIds.length === 0 || isAddingCountries">
          <span *ngIf="isAddingCountries" class="spinner-border spinner-border-sm me-2"></span>
          <i class="bi bi-check-circle me-2" *ngIf="!isAddingCountries"></i>
          {{ i18n.t('users.detail.add_selected') }}
        </button>
      </div>
    </div>
  </div>
</div>
<div *ngIf="showAddCountriesModal" class="modal-backdrop fade show"></div>
