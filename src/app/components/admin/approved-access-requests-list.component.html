<app-authenticated-navbar
  [title]="i18n.t('internal.nav.title')"
  [userType]="'internal'">
</app-authenticated-navbar>

<div class="container  py-5">
  <div class="row justify-content-center">
    <div class="col-12 col-lg-12">
      <div class="card shadow-sm">
        <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
          <h4 class="mb-0">
            <i class="bi bi-check-circle me-2"></i>
            {{ i18n.getCurrentLocale() === 'fr' ? 'Demandes d\'accès approuvées' : 'Approved Access Requests' }}
          </h4>
          <button class="btn btn-light btn-sm" (click)="goBack()">
            <i class="bi bi-arrow-left me-2"></i>{{ i18n.t('disbursements.backToList') }}
          </button>
        </div>

        <div class="card-body">
          <div class="row mb-4">
            <div class="col-md-4 mb-3 mb-md-0">
              <label class="form-label fw-bold">
                <i class="bi bi-geo-alt me-1"></i>
                {{ i18n.getCurrentLocale() === 'fr' ? 'Pays' : 'Country' }}
              </label>
              <select
                class="form-select"
                [(ngModel)]="selectedCountryId"
                (change)="onCountryChange()">
                <option value="">{{ i18n.getCurrentLocale() === 'fr' ? 'Tous les pays' : 'All Countries' }}</option>
                <option *ngFor="let country of countries" [value]="country.id">
                  {{ country.name }}
                </option>
              </select>
            </div>

            <div class="col-md-4 mb-3 mb-md-0">
              <label class="form-label fw-bold">
                <i class="bi bi-folder me-1"></i>
                {{ i18n.getCurrentLocale() === 'fr' ? 'Projet' : 'Project' }}
              </label>
              <select
                class="form-select"
                [(ngModel)]="selectedProjectCode"
                (change)="onProjectChange()"
                [disabled]="!selectedCountryId || isLoadingProjects">
                <option value="">
                  {{ !selectedCountryId
                    ? (i18n.getCurrentLocale() === 'fr' ? 'Sélectionnez d\'abord un pays' : 'Select a country first')
                    : isLoadingProjects
                    ? (i18n.getCurrentLocale() === 'fr' ? 'Chargement...' : 'Loading...')
                    : (i18n.getCurrentLocale() === 'fr' ? 'Tous les projets' : 'All Projects') }}
                </option>
                <option *ngFor="let project of projects" [value]="project.sapCode">
                  {{ project.sapCode }} - {{ project.projectName }}
                </option>
              </select>
              @if (isLoadingProjects) {
                <div class="mt-2">
                  <small class="text-muted">
                    <span class="spinner-border spinner-border-sm me-1"></span>
                    {{ i18n.getCurrentLocale() === 'fr' ? 'Chargement des projets...' : 'Loading projects...' }}
                  </small>
                </div>
              }
            </div>

            <div class="col-md-4 d-flex align-items-end">
              <button class="btn btn-outline-secondary w-100" (click)="resetFilters()">
                <i class="bi bi-arrow-clockwise me-2"></i>
                {{ i18n.getCurrentLocale() === 'fr' ? 'Réinitialiser les filtres' : 'Reset Filters' }}
              </button>
            </div>
          </div>

          @if (errorMessage) {
            <div class="alert alert-danger">
              <i class="bi bi-exclamation-triangle me-2"></i>
              {{ errorMessage }}
            </div>
          }

          @if (isLoading) {
            <div class="text-center py-5">
              <div class="spinner-border text-success" role="status">
                <span class="visually-hidden">{{ i18n.t('common.loading') }}</span>
              </div>
            </div>
          }

          @if (!isLoading && !errorMessage) {
            <div class="alert alert-info mb-4">
              <i class="bi bi-info-circle me-2"></i>
              {{ i18n.getCurrentLocale() === 'fr'
                ? 'Total : ' + requestResponse.totalCount + ' demande(s) approuvée(s)'
                : 'Total: ' + requestResponse.totalCount + ' approved request(s)' }}
            </div>

            @if (requestResponse.accessRequests.length === 0) {
              <div class="alert alert-warning text-center py-5">
                <i class="bi bi-inbox fs-1 d-block mb-3"></i>
                <h5>{{ i18n.getCurrentLocale() === 'fr' ? 'Aucune demande approuvée trouvée' : 'No approved requests found' }}</h5>
                <p class="text-muted">
                  {{ i18n.getCurrentLocale() === 'fr'
                    ? 'Essayez de modifier vos filtres pour voir plus de résultats.'
                    : 'Try adjusting your filters to see more results.' }}
                </p>
              </div>
            }

            @if (requestResponse.accessRequests.length > 0) {
              <div class="table-responsive">
                <table class="table table-hover align-middle">
                  <thead class="table-light">
                    <tr>
                      <th>{{ i18n.getCurrentLocale() === 'fr' ? 'Nom' : 'Name' }}</th>
                      <th>{{ i18n.getCurrentLocale() === 'fr' ? 'Email' : 'Email' }}</th>
                      <th>{{ i18n.getCurrentLocale() === 'fr' ? 'Pays' : 'Country' }}</th>
                      <th>{{ i18n.getCurrentLocale() === 'fr' ? 'Profil' : 'Profile' }}</th>
                      <th class="text-center">{{ i18n.getCurrentLocale() === 'fr' ? 'Projets' : 'Projects' }}</th>
                      <th>{{ i18n.getCurrentLocale() === 'fr' ? 'Date d\'approbation' : 'Approval Date' }}</th>
                      <th class="text-center">{{ i18n.getCurrentLocale() === 'fr' ? 'Actions' : 'Actions' }}</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let request of requestResponse.accessRequests" class="cursor-pointer">
                      <td>
                        <strong>{{ request.firstName }} {{ request.lastName }}</strong>
                      </td>
                      <td>{{ request.email }}</td>
                      <td>{{ request.countryName }}</td>
                      <td>
                        <small class="text-muted">{{ request.businessProfileName }}</small>
                      </td>
                      <td class="text-center">
                        <span class="badge bg-primary rounded-pill">
                          {{ request.selectedProjectCodes.length }}
                        </span>
                      </td>
                      <td>
                        <small>{{ request.processedDate | date: 'short' }}</small>
                      </td>
                      <td class="text-center">
                        <button
                          class="btn btn-sm btn-outline-primary"
                          (click)="viewDetail(request.id)">
                          <i class="bi bi-eye me-1"></i>
                          {{ i18n.getCurrentLocale() === 'fr' ? 'Détails' : 'Details' }}
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <nav *ngIf="requestResponse.totalPages > 1" class="mt-4">
                <ul class="pagination justify-content-center">
                  <li class="page-item" [class.disabled]="currentPage === 1">
                    <button class="page-link" (click)="previousPage()">
                      <i class="bi bi-chevron-left"></i>
                      {{ i18n.getCurrentLocale() === 'fr' ? 'Précédent' : 'Previous' }}
                    </button>
                  </li>

                  <li *ngFor="let page of getPageNumbers()"
                      class="page-item"
                      [class.active]="page === currentPage"
                      [class.disabled]="page === -1">
                    <button *ngIf="page !== -1" class="page-link" (click)="goToPage(page)">
                      {{ page }}
                    </button>
                    <span *ngIf="page === -1" class="page-link">...</span>
                  </li>

                  <li class="page-item" [class.disabled]="currentPage === requestResponse.totalPages">
                    <button class="page-link" (click)="nextPage()">
                      {{ i18n.getCurrentLocale() === 'fr' ? 'Suivant' : 'Next' }}
                      <i class="bi bi-chevron-right"></i>
                    </button>
                  </li>
                </ul>
              </nav>
            }
          }
        </div>
      </div>
    </div>
  </div>
</div>
